/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Optional, Inject } from '@angular/core';
import { ReplaySubject, fromEvent, of, throwError, race } from 'rxjs';
import { map, mergeMap, first, tap, filter } from 'rxjs/operators';
import { LocalStorageDatabase } from './localstorage-database';
import { LOCAL_STORAGE_PREFIX } from '../tokens';
import * as i0 from "@angular/core";
import * as i1 from "../tokens";
var IndexedDBDatabase = /** @class */ (function () {
    /**
     * Connects to IndexedDB
     */
    function IndexedDBDatabase(prefix) {
        if (prefix === void 0) { prefix = null; }
        this.prefix = prefix;
        /**
         * IndexedDB database name for local storage
         */
        this.dbName = 'ngStorage';
        /**
         * IndexedDB object store name for local storage
         */
        this.objectStoreName = 'localStorage';
        /**
         * IndexedDB key path name for local storage (where an item's key will be stored)
         */
        this.keyPath = 'key';
        /**
         * IndexedDB data path name for local storage (where items' value will be stored)
         */
        this.dataPath = 'value';
        /**
         * IndexedDB is available but failing in some scenarios (Firefox private mode, Safari cross-origin iframes),
         * so a fallback can be needed.
         */
        this.fallback = null;
        if (prefix) {
            this.dbName = prefix + "_" + this.dbName;
        }
        /* Creating the RxJS ReplaySubject */
        this.database = new ReplaySubject();
        /* Connecting to IndexedDB */
        this.connect(prefix);
    }
    Object.defineProperty(IndexedDBDatabase.prototype, "size", {
        get: /**
         * @return {?}
         */
        function () {
            var _this = this;
            /* Fallback storage if set */
            if (this.fallback) {
                return this.fallback.size;
            }
            return this.transaction('readonly').pipe(mergeMap(function (transaction) {
                /* Deleting the item in local storage */
                /** @type {?} */
                var request = transaction.count();
                /** @type {?} */
                var success = ((/** @type {?} */ (fromEvent(request, 'success')))).pipe(map(function (event) { return (/** @type {?} */ (((/** @type {?} */ (event.target))).result)); }));
                /* Merging success and errors events and autoclosing the observable */
                return ((/** @type {?} */ (race(success, _this.toErrorObservable(request, "length")))));
            }), first());
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Gets an item value in local storage
     * @param key The item's key
     * @returns The item's value if the key exists, null otherwise, wrapped in an RxJS Observable
     */
    /**
     * Gets an item value in local storage
     * @template T
     * @param {?} key The item's key
     * @return {?} The item's value if the key exists, null otherwise, wrapped in an RxJS Observable
     */
    IndexedDBDatabase.prototype.getItem = /**
     * Gets an item value in local storage
     * @template T
     * @param {?} key The item's key
     * @return {?} The item's value if the key exists, null otherwise, wrapped in an RxJS Observable
     */
    function (key) {
        var _this = this;
        /* Fallback storage if set */
        if (this.fallback) {
            return this.fallback.getItem(key);
        }
        /* Opening a trasaction and requesting the item in local storage */
        return this.transaction().pipe(map(function (transaction) { return transaction.get(key); }), mergeMap(function (request) {
            /* Listening to the success event, and passing the item value if found, null otherwise */
            /** @type {?} */
            var success = ((/** @type {?} */ (fromEvent(request, 'success')))).pipe(map(function (event) { return ((/** @type {?} */ (event.target))).result; }), map(function (result) {
                if ((result != null) && (typeof result === 'object') && (_this.dataPath in result) && (result[_this.dataPath] != null)) {
                    return ((/** @type {?} */ (result[_this.dataPath])));
                }
                else if (result != null) {
                    return (/** @type {?} */ (result));
                }
                return null;
            }));
            /* Merging success and errors events and autoclosing the observable */
            return (race(success, _this.toErrorObservable(request, "getter")));
        }), first());
    };
    /**
     * Sets an item in local storage
     * @param key The item's key
     * @param data The item's value, must NOT be null or undefined
     * @returns An RxJS Observable to wait the end of the operation
     */
    /**
     * Sets an item in local storage
     * @param {?} key The item's key
     * @param {?} data The item's value, must NOT be null or undefined
     * @return {?} An RxJS Observable to wait the end of the operation
     */
    IndexedDBDatabase.prototype.setItem = /**
     * Sets an item in local storage
     * @param {?} key The item's key
     * @param {?} data The item's value, must NOT be null or undefined
     * @return {?} An RxJS Observable to wait the end of the operation
     */
    function (key, data) {
        var _this = this;
        /* Fallback storage if set */
        if (this.fallback) {
            return this.fallback.setItem(key, data);
        }
        /* Storing null is not correctly supported by IndexedDB and unnecessary here */
        if (data == null) {
            return of(true);
        }
        /* Transaction must be the same for read and write, to avoid concurrency issues */
        /** @type {?} */
        var transaction$ = this.transaction('readwrite');
        /** @type {?} */
        var transaction;
        /* Opening a transaction */
        return transaction$.pipe(tap(function (value) {
            transaction = value;
        }), 
        /* Check if the key already exists or not
         * `getKey()` is only available in indexedDb v2 (Chrome >= 58)
         * In older browsers, the value is checked instead, but it could lead to an exception
         * if `undefined` was stored outside of this lib (e.g. directly with the native `indexedDb` API)
         */
        map(function () { return ('getKey' in transaction) ? transaction.getKey(key) : ((/** @type {?} */ (transaction))).get(key); }), mergeMap(function (request) {
            /* Listening to the success event, and passing the item value if found, null otherwise */
            /** @type {?} */
            var success = ((/** @type {?} */ (fromEvent(request, 'success')))).pipe(map(function (event) { return (/** @type {?} */ (((/** @type {?} */ (event.target))).result)); }));
            /* Merging success and errors events and autoclosing the observable */
            return (race(success, _this.toErrorObservable(request, "setter")));
        }), mergeMap(function (existingEntry) {
            var _a, _b;
            /* Adding or updating local storage, based on previous checking */
            /** @type {?} */
            var request = (existingEntry === undefined) ?
                transaction.add((_a = {}, _a[_this.dataPath] = data, _a), key) :
                transaction.put((_b = {}, _b[_this.dataPath] = data, _b), key);
            /* Merging success (passing true) and error events and autoclosing the observable */
            return (race(_this.toSuccessObservable(request), _this.toErrorObservable(request, "setter")));
        }), first());
    };
    /**
     * Deletes an item in local storage
     * @param key The item's key
     * @returns An RxJS Observable to wait the end of the operation
     */
    /**
     * Deletes an item in local storage
     * @param {?} key The item's key
     * @return {?} An RxJS Observable to wait the end of the operation
     */
    IndexedDBDatabase.prototype.removeItem = /**
     * Deletes an item in local storage
     * @param {?} key The item's key
     * @return {?} An RxJS Observable to wait the end of the operation
     */
    function (key) {
        var _this = this;
        /* Fallback storage if set */
        if (this.fallback) {
            return this.fallback.removeItem(key);
        }
        /* Opening a transaction and checking if the item exists in local storage */
        return this.getItem(key).pipe(mergeMap(function (data) {
            /* If the item exists in local storage */
            if (data != null) {
                /* Opening a transaction */
                return _this.transaction('readwrite').pipe(mergeMap(function (transaction) {
                    /* Deleting the item in local storage */
                    /** @type {?} */
                    var request = transaction.delete(key);
                    /* Merging success (passing true) and error events and autoclosing the observable */
                    return (race(_this.toSuccessObservable(request), _this.toErrorObservable(request, "remover")));
                }));
            }
            /* Passing true if the item does not exist in local storage */
            return of(true);
        }), first());
    };
    /**
     * Deletes all items from local storage
     * @returns An RxJS Observable to wait the end of the operation
     */
    /**
     * Deletes all items from local storage
     * @return {?} An RxJS Observable to wait the end of the operation
     */
    IndexedDBDatabase.prototype.clear = /**
     * Deletes all items from local storage
     * @return {?} An RxJS Observable to wait the end of the operation
     */
    function () {
        var _this = this;
        /* Fallback storage if set */
        if (this.fallback) {
            return this.fallback.clear();
        }
        /* Opening a transaction */
        return this.transaction('readwrite').pipe(mergeMap(function (transaction) {
            /* Deleting all items from local storage */
            /** @type {?} */
            var request = transaction.clear();
            /* Merging success (passing true) and error events and autoclosing the observable */
            return (race(_this.toSuccessObservable(request), _this.toErrorObservable(request, "clearer")));
        }), first());
    };
    /**
     * @return {?}
     */
    IndexedDBDatabase.prototype.keys = /**
     * @return {?}
     */
    function () {
        var _this = this;
        /* Fallback storage if set */
        if (this.fallback) {
            return this.fallback.keys();
        }
        return this.transaction('readonly').pipe(mergeMap(function (transaction) {
            if ('getAllKeys' in transaction) {
                /* Deleting the item in local storage */
                /** @type {?} */
                var request = transaction.getAllKeys();
                /** @type {?} */
                var success = ((/** @type {?} */ (fromEvent(request, 'success')))).pipe(map(function (event) { return (/** @type {?} */ (((/** @type {?} */ (event.target))).result)); }));
                /* Merging success and errors events and autoclosing the observable */
                return (race(success, _this.toErrorObservable(request, "keys")));
            }
            else {
                /* `getAllKeys()` is from IndexedDB v2.0 standard, which is not supported in IE/Edge */
                /** @type {?} */
                var request = ((/** @type {?} */ (transaction))).openCursor();
                /** @type {?} */
                var keys_1 = [];
                /** @type {?} */
                var success = fromEvent(request, 'success').pipe(map(function (event) { return (/** @type {?} */ (((/** @type {?} */ (event.target))).result)); }), tap(function (cursor) {
                    if (cursor) {
                        keys_1.push((/** @type {?} */ (cursor.key)));
                        cursor.continue();
                    }
                }), filter(function (cursor) { return !cursor; }), map(function () { return keys_1; }));
                /* Merging success and errors events and autoclosing the observable */
                return (race(success, _this.toErrorObservable(request, "keys")));
            }
        }), first());
    };
    /**
     * @param {?} key
     * @return {?}
     */
    IndexedDBDatabase.prototype.has = /**
     * @param {?} key
     * @return {?}
     */
    function (key) {
        var _this = this;
        /* Fallback storage if set */
        if (this.fallback) {
            return this.fallback.has(key);
        }
        return this.transaction('readonly').pipe(
        /* `getKey()` is from IndexedDB v2.0 standard, which is not supported in IE/Edge */
        map(function (transaction) { return ('getKey' in transaction) ? transaction.getKey(key) : ((/** @type {?} */ (transaction))).get(key); }), mergeMap(function (request) {
            /* Listening to the success event, and passing the item value if found, null otherwise */
            /** @type {?} */
            var success = ((/** @type {?} */ (fromEvent(request, 'success')))).pipe(map(function (event) { return ((/** @type {?} */ (event.target))).result; }), map(function (result) { return (result !== undefined) ? true : false; }));
            /* Merging success and errors events and autoclosing the observable */
            return (race(success, _this.toErrorObservable(request, "has")));
        }), first());
    };
    /**
     * Connects to IndexedDB and creates the object store on first time
     */
    /**
     * Connects to IndexedDB and creates the object store on first time
     * @protected
     * @param {?=} prefix
     * @return {?}
     */
    IndexedDBDatabase.prototype.connect = /**
     * Connects to IndexedDB and creates the object store on first time
     * @protected
     * @param {?=} prefix
     * @return {?}
     */
    function (prefix) {
        var _this = this;
        if (prefix === void 0) { prefix = null; }
        /** @type {?} */
        var request;
        /* Connecting to IndexedDB */
        try {
            request = indexedDB.open(this.dbName);
        }
        catch (error) {
            /* Fallback storage if IndexedDb connection is failing */
            this.setFallback(prefix);
            return;
        }
        /* Listening the event fired on first connection, creating the object store for local storage */
        ((/** @type {?} */ (fromEvent(request, 'upgradeneeded'))))
            .pipe(first())
            .subscribe(function (event) {
            /* Getting the database connection */
            /** @type {?} */
            var database = (/** @type {?} */ (((/** @type {?} */ (event.target))).result));
            /* Checking if the object store already exists, to avoid error */
            if (!database.objectStoreNames.contains(_this.objectStoreName)) {
                /* Creating the object store for local storage */
                database.createObjectStore(_this.objectStoreName);
            }
        });
        /* Listening the success event and converting to an RxJS Observable */
        /** @type {?} */
        var success = (/** @type {?} */ (fromEvent(request, 'success')));
        /* Merging success and errors events */
        ((/** @type {?} */ (race(success, this.toErrorObservable(request, "connection")))))
            .pipe(first())
            .subscribe(function (event) {
            /* Storing the database connection for further access */
            _this.database.next((/** @type {?} */ (((/** @type {?} */ (event.target))).result)));
        }, function () {
            /* Fallback storage if IndexedDb connection is failing */
            _this.setFallback(prefix);
        });
    };
    /**
     * Opens an IndexedDB transaction and gets the local storage object store
     * @param mode Default to 'readonly' for read operations, or 'readwrite' for write operations
     * @returns An IndexedDB transaction object store, wrapped in an RxJS Observable
     */
    /**
     * Opens an IndexedDB transaction and gets the local storage object store
     * @protected
     * @param {?=} mode Default to 'readonly' for read operations, or 'readwrite' for write operations
     * @return {?} An IndexedDB transaction object store, wrapped in an RxJS Observable
     */
    IndexedDBDatabase.prototype.transaction = /**
     * Opens an IndexedDB transaction and gets the local storage object store
     * @protected
     * @param {?=} mode Default to 'readonly' for read operations, or 'readwrite' for write operations
     * @return {?} An IndexedDB transaction object store, wrapped in an RxJS Observable
     */
    function (mode) {
        var _this = this;
        if (mode === void 0) { mode = 'readonly'; }
        /* From the IndexedDB connection, opening a transaction and getting the local storage objet store */
        return this.database
            .pipe(map(function (database) { return database.transaction([_this.objectStoreName], mode).objectStore(_this.objectStoreName); }));
    };
    /**
     * Transforms a IndexedDB success event in an RxJS Observable
     * @param request The request to listen
     * @returns A RxJS Observable with true value
     */
    /**
     * Transforms a IndexedDB success event in an RxJS Observable
     * @protected
     * @param {?} request The request to listen
     * @return {?} A RxJS Observable with true value
     */
    IndexedDBDatabase.prototype.toSuccessObservable = /**
     * Transforms a IndexedDB success event in an RxJS Observable
     * @protected
     * @param {?} request The request to listen
     * @return {?} A RxJS Observable with true value
     */
    function (request) {
        /* Transforming a IndexedDB success event in an RxJS Observable with true value */
        return ((/** @type {?} */ (fromEvent(request, 'success'))))
            .pipe(map(function () { return true; }));
    };
    /**
     * Transforms a IndexedDB error event in an RxJS ErrorObservable
     * @param request The request to listen
     * @param error Optionnal details about the error's origin
     * @returns A RxJS ErrorObservable
     */
    /**
     * Transforms a IndexedDB error event in an RxJS ErrorObservable
     * @protected
     * @param {?} request The request to listen
     * @param {?=} error Optionnal details about the error's origin
     * @return {?} A RxJS ErrorObservable
     */
    IndexedDBDatabase.prototype.toErrorObservable = /**
     * Transforms a IndexedDB error event in an RxJS ErrorObservable
     * @protected
     * @param {?} request The request to listen
     * @param {?=} error Optionnal details about the error's origin
     * @return {?} A RxJS ErrorObservable
     */
    function (request, error) {
        if (error === void 0) { error = ""; }
        /* Transforming a IndexedDB error event in an RxJS ErrorObservable */
        return ((/** @type {?} */ (fromEvent(request, 'error'))))
            .pipe(mergeMap(function () { return throwError(new Error("IndexedDB " + error + " issue : " + ((/** @type {?} */ (request.error))).message + ".")); }));
    };
    /**
     * @protected
     * @param {?} prefix
     * @return {?}
     */
    IndexedDBDatabase.prototype.setFallback = /**
     * @protected
     * @param {?} prefix
     * @return {?}
     */
    function (prefix) {
        this.fallback = new LocalStorageDatabase(prefix);
    };
    IndexedDBDatabase.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    IndexedDBDatabase.ctorParameters = function () { return [
        { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [LOCAL_STORAGE_PREFIX,] }] }
    ]; };
    /** @nocollapse */ IndexedDBDatabase.ngInjectableDef = i0.defineInjectable({ factory: function IndexedDBDatabase_Factory() { return new IndexedDBDatabase(i0.inject(i1.LOCAL_STORAGE_PREFIX, 8)); }, token: IndexedDBDatabase, providedIn: "root" });
    return IndexedDBDatabase;
}());
export { IndexedDBDatabase };
if (false) {
    /**
     * IndexedDB database name for local storage
     * @type {?}
     * @protected
     */
    IndexedDBDatabase.prototype.dbName;
    /**
     * IndexedDB object store name for local storage
     * @type {?}
     * @protected
     */
    IndexedDBDatabase.prototype.objectStoreName;
    /**
     * IndexedDB key path name for local storage (where an item's key will be stored)
     * @type {?}
     * @protected
     */
    IndexedDBDatabase.prototype.keyPath;
    /**
     * IndexedDB data path name for local storage (where items' value will be stored)
     * @type {?}
     * @protected
     */
    IndexedDBDatabase.prototype.dataPath;
    /**
     * IndexedDB database connection, wrapped in a RxJS ReplaySubject to be able to access the connection
     * even after the connection success event happened
     * @type {?}
     * @protected
     */
    IndexedDBDatabase.prototype.database;
    /**
     * IndexedDB is available but failing in some scenarios (Firefox private mode, Safari cross-origin iframes),
     * so a fallback can be needed.
     * @type {?}
     * @protected
     */
    IndexedDBDatabase.prototype.fallback;
    /**
     * @type {?}
     * @protected
     */
    IndexedDBDatabase.prototype.prefix;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXhlZGRiLWRhdGFiYXNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQG5neC1wd2EvbG9jYWwtc3RvcmFnZS8iLCJzb3VyY2VzIjpbImxpYi9kYXRhYmFzZXMvaW5kZXhlZGRiLWRhdGFiYXNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDN0QsT0FBTyxFQUFjLGFBQWEsRUFBRSxTQUFTLEVBQUUsRUFBRSxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDbEYsT0FBTyxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUduRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxXQUFXLENBQUM7OztBQUVqRDtJQTBERTs7T0FFRztJQUNILDJCQUFnRSxNQUE0QjtRQUE1Qix1QkFBQSxFQUFBLGFBQTRCO1FBQTVCLFdBQU0sR0FBTixNQUFNLENBQXNCOzs7O1FBckRsRixXQUFNLEdBQUcsV0FBVyxDQUFDOzs7O1FBSVosb0JBQWUsR0FBRyxjQUFjLENBQUM7Ozs7UUFJakMsWUFBTyxHQUFHLEtBQUssQ0FBQzs7OztRQUloQixhQUFRLEdBQUcsT0FBTyxDQUFDOzs7OztRQVU1QixhQUFRLEdBQXlCLElBQUksQ0FBQztRQWlDOUMsSUFBSSxNQUFNLEVBQUU7WUFFVixJQUFJLENBQUMsTUFBTSxHQUFNLE1BQU0sU0FBSSxJQUFJLENBQUMsTUFBUSxDQUFDO1NBRTFDO1FBRUQscUNBQXFDO1FBQ3JDLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxhQUFhLEVBQWUsQ0FBQztRQUVqRCw2QkFBNkI7UUFDN0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENB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QUFTLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxFQUFxQixDQUFDO2FBQ3RELElBQUksQ0FDSCxRQUFRLENBQUMsY0FBTSxPQUFBLFVBQVUsQ0FBQyxJQUFJLEtBQUssQ0FBQyxlQUFhLEtBQUssaUJBQVksQ0FBQyxtQkFBQSxPQUFPLENBQUMsS0FBSyxFQUFnQixDQUFDLENBQUMsT0FBTyxNQUFHLENBQUMsQ0FBQyxFQUEvRixDQUErRixDQUFDLENBQ2hILENBQUM7SUFFTixDQUFDOzs7Ozs7SUFFUyx1Q0FBVzs7Ozs7SUFBckIsVUFBc0IsTUFBcUI7UUFDekMsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ25ELENBQUM7O2dCQTlhRixVQUFVLFNBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25COzs7O2dEQTJEYyxRQUFRLFlBQUksTUFBTSxTQUFDLG9CQUFvQjs7OzRCQXJFdEQ7Q0F3YkMsQUFoYkQsSUFnYkM7U0E3YVksaUJBQWlCOzs7Ozs7O0lBSzVCLG1DQUErQjs7Ozs7O0lBSS9CLDRDQUFvRDs7Ozs7O0lBSXBELG9DQUFtQzs7Ozs7O0lBSW5DLHFDQUFzQzs7Ozs7OztJQUt0QyxxQ0FBK0M7Ozs7Ozs7SUFLL0MscUNBQWdEOzs7OztJQStCcEMsbUNBQWdGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgT3B0aW9uYWwsIEluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgUmVwbGF5U3ViamVjdCwgZnJvbUV2ZW50LCBvZiwgdGhyb3dFcnJvciwgcmFjZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwLCBtZXJnZU1hcCwgZmlyc3QsIHRhcCwgZmlsdGVyIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBMb2NhbERhdGFiYXNlIH0gZnJvbSAnLi9sb2NhbC1kYXRhYmFzZSc7XG5pbXBvcnQgeyBMb2NhbFN0b3JhZ2VEYXRhYmFzZSB9IGZyb20gJy4vbG9jYWxzdG9yYWdlLWRhdGFiYXNlJztcbmltcG9ydCB7IExPQ0FMX1NUT1JBR0VfUFJFRklYIH0gZnJvbSAnLi4vdG9rZW5zJztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgSW5kZXhlZERCRGF0YWJhc2UgaW1wbGVtZW50cyBMb2NhbERhdGFiYXNlIHtcblxuICAvKipcbiAgICogSW5kZXhlZERCIGRhdGFiYXNlIG5hbWUgZm9yIGxvY2FsIHN0b3JhZ2VcbiAgICovXG4gIHByb3RlY3RlZCBkYk5hbWUgPSAnbmdTdG9yYWdlJztcbiAgLyoqXG4gICAqIEluZGV4ZWREQiBvYmplY3Qgc3RvcmUgbmFtZSBmb3IgbG9jYWwgc3RvcmFnZVxuICAgKi9cbiAgcHJvdGVjdGVkIHJlYWRvbmx5IG9iamVjdFN0b3JlTmFtZSA9ICdsb2NhbFN0b3JhZ2UnO1xuICAvKipcbiAgICogSW5kZXhlZERCIGtleSBwYXRoIG5hbWUgZm9yIGxvY2FsIHN0b3JhZ2UgKHdoZXJlIGFuIGl0ZW0ncyBrZXkgd2lsbCBiZSBzdG9yZWQpXG4gICAqL1xuICBwcm90ZWN0ZWQgcmVhZG9ubHkga2V5UGF0aCA9ICdrZXknO1xuICAvKipcbiAgICogSW5kZXhlZERCIGRhdGEgcGF0aCBuYW1lIGZvciBsb2NhbCBzdG9yYWdlICh3aGVyZSBpdGVtcycgdmFsdWUgd2lsbCBiZSBzdG9yZWQpXG4gICAqL1xuICBwcm90ZWN0ZWQgcmVhZG9ubHkgZGF0YVBhdGggPSAndmFsdWUnO1xuICAvKipcbiAgICogSW5kZXhlZERCIGRhdGFiYXNlIGNvbm5lY3Rpb24sIHdyYXBwZWQgaW4gYSBSeEpTIFJlcGxheVN1YmplY3QgdG8gYmUgYWJsZSB0byBhY2Nlc3MgdGhlIGNvbm5lY3Rpb25cbiAgICogZXZlbiBhZnRlciB0aGUgY29ubmVjdGlvbiBzdWNjZXNzIGV2ZW50IGhhcHBlbmVkXG4gICAqL1xuICBwcm90ZWN0ZWQgZGF0YWJhc2U6IFJlcGxheVN1YmplY3Q8SURCRGF0YWJhc2U+O1xuICAvKipcbiAgICogSW5kZXhlZERCIGlzIGF2YWlsYWJsZSBidXQgZmFpbGluZyBpbiBzb21lIHNjZW5hcmlvcyAoRmlyZWZveCBwcml2YXRlIG1vZGUsIFNhZmFyaSBjcm9zcy1vcmlnaW4gaWZyYW1lcyksXG4gICAqIHNvIGEgZmFsbGJhY2sgY2FuIGJlIG5lZWRlZC5cbiAgICovXG4gIHByb3RlY3RlZCBmYWxsYmFjazogTG9jYWxEYXRhYmFzZSB8IG51bGwgPSBudWxsO1xuXG4gIGdldCBzaXplKCk6IE9ic2VydmFibGU8bnVtYmVyPiB7XG5cbiAgICAvKiBGYWxsYmFjayBzdG9yYWdlIGlmIHNldCAqL1xuICAgIGlmICh0aGlzLmZhbGxiYWNrKSB7XG4gICAgICByZXR1cm4gdGhpcy5mYWxsYmFjay5zaXplO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnRyYW5zYWN0aW9uKCdyZWFkb25seScpLnBpcGUoXG4gICAgICBtZXJnZU1hcCgodHJhbnNhY3Rpb24pID0+IHtcblxuICAgICAgICAvKiBEZWxldGluZyB0aGUgaXRlbSBpbiBsb2NhbCBzdG9yYWdlICovXG4gICAgICAgIGNvbnN0IHJlcXVlc3QgPSB0cmFuc2FjdGlvbi5jb3VudCgpO1xuXG4gICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSAoZnJvbUV2ZW50KHJlcXVlc3QsICdzdWNjZXNzJykgYXMgT2JzZXJ2YWJsZTxFdmVudD4pLnBpcGUoXG4gICAgICAgICAgbWFwKChldmVudCkgPT4gKGV2ZW50LnRhcmdldCBhcyBJREJSZXF1ZXN0KS5yZXN1bHQgYXMgbnVtYmVyKSxcbiAgICAgICAgKTtcblxuICAgICAgICAvKiBNZXJnaW5nIHN1Y2Nlc3MgYW5kIGVycm9ycyBldmVudHMgYW5kIGF1dG9jbG9zaW5nIHRoZSBvYnNlcnZhYmxlICovXG4gICAgICAgIHJldHVybiAocmFjZShzdWNjZXNzLCB0aGlzLnRvRXJyb3JPYnNlcnZhYmxlKHJlcXVlc3QsIGBsZW5ndGhgKSkgYXMgT2JzZXJ2YWJsZTxudW1iZXI+KTtcblxuICAgICAgfSksXG4gICAgICBmaXJzdCgpXG4gICAgKTtcblxuICB9XG5cbiAgLyoqXG4gICAqIENvbm5lY3RzIHRvIEluZGV4ZWREQlxuICAgKi9cbiAgY29uc3RydWN0b3IoQE9wdGlvbmFsKCkgQEluamVjdChMT0NBTF9TVE9SQUdFX1BSRUZJWCkgcHJvdGVjdGVkIHByZWZpeDogc3RyaW5nIHwgbnVsbCA9IG51bGwpIHtcblxuICAgIGlmIChwcmVmaXgpIHtcblxuICAgICAgdGhpcy5kYk5hbWUgPSBgJHtwcmVmaXh9XyR7dGhpcy5kYk5hbWV9YDtcblxuICAgIH1cblxuICAgIC8qIENyZWF0aW5nIHRoZSBSeEpTIFJlcGxheVN1YmplY3QgKi9cbiAgICB0aGlzLmRhdGFiYXNlID0gbmV3IFJlcGxheVN1YmplY3Q8SURCRGF0YWJhc2U+KCk7XG5cbiAgICAvKiBDb25uZWN0aW5nIHRvIEluZGV4ZWREQiAqL1xuICAgIHRoaXMuY29ubmVjdChwcmVmaXgpO1xuXG4gIH1cblxuICAvKipcbiAgICogR2V0cyBhbiBpdGVtIHZhbHVlIGluIGxvY2FsIHN0b3JhZ2VcbiAgICogQHBhcmFtIGtleSBUaGUgaXRlbSdzIGtleVxuICAgKiBAcmV0dXJucyBUaGUgaXRlbSdzIHZhbHVlIGlmIHRoZSBrZXkgZXhpc3RzLCBudWxsIG90aGVyd2lzZSwgd3JhcHBlZCBpbiBhbiBSeEpTIE9ic2VydmFibGVcbiAgICovXG4gIGdldEl0ZW08VCA9IGFueT4oa2V5OiBzdHJpbmcpOiBPYnNlcnZhYmxlPFTCoHwgbnVsbD4ge1xuXG4gICAgLyogRmFsbGJhY2sgc3RvcmFnZSBpZiBzZXQgKi9cbiAgICBpZiAodGhpcy5mYWxsYmFjaykge1xuICAgICAgcmV0dXJuIHRoaXMuZmFsbGJhY2suZ2V0SXRlbTxUPihrZXkpO1xuICAgIH1cblxuICAgIC8qIE9wZW5pbmcgYSB0cmFzYWN0aW9uIGFuZCByZXF1ZXN0aW5nIHRoZSBpdGVtIGluIGxvY2FsIHN0b3JhZ2UgKi9cbiAgICByZXR1cm4gdGhpcy50cmFuc2FjdGlvbigpLnBpcGUoXG4gICAgICBtYXAoKHRyYW5zYWN0aW9uKSA9PiB0cmFuc2FjdGlvbi5nZXQoa2V5KSksXG4gICAgICBtZXJnZU1hcCgocmVxdWVzdCkgPT4ge1xuXG4gICAgICAgIC8qIExpc3RlbmluZyB0byB0aGUgc3VjY2VzcyBldmVudCwgYW5kIHBhc3NpbmcgdGhlIGl0ZW0gdmFsdWUgaWYgZm91bmQsIG51bGwgb3RoZXJ3aXNlICovXG4gICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSAoZnJvbUV2ZW50KHJlcXVlc3QsICdzdWNjZXNzJykgYXMgT2JzZXJ2YWJsZTxFdmVudD4pLnBpcGUoXG4gICAgICAgICAgbWFwKChldmVudCkgPT4gKGV2ZW50LnRhcmdldCBhcyBJREJSZXF1ZXN0KS5yZXN1bHQpLFxuICAgICAgICAgIG1hcCgocmVzdWx0KSA9PiB7XG5cbiAgICAgICAgICAgIGlmICgocmVzdWx0ICE9IG51bGwpICYmICh0eXBlb2YgcmVzdWx0ID09PSAnb2JqZWN0JykgJiYgKHRoaXMuZGF0YVBhdGggaW4gcmVzdWx0KSAmJiAocmVzdWx0W3RoaXMuZGF0YVBhdGhdICE9IG51bGwpKSB7XG4gICAgICAgICAgICAgIHJldHVybiAocmVzdWx0W3RoaXMuZGF0YVBhdGhdIGFzIFQpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChyZXN1bHQgIT0gbnVsbCkge1xuICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0IGFzIFQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuXG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcblxuICAgICAgICAvKiBNZXJnaW5nIHN1Y2Nlc3MgYW5kIGVycm9ycyBldmVudHMgYW5kIGF1dG9jbG9zaW5nIHRoZSBvYnNlcnZhYmxlICovXG4gICAgICAgIHJldHVybiAocmFjZShzdWNjZXNzLCB0aGlzLnRvRXJyb3JPYnNlcnZhYmxlKHJlcXVlc3QsIGBnZXR0ZXJgKSkpO1xuICAgICAgfSksXG4gICAgICBmaXJzdCgpXG4gICAgKTtcblxuICB9XG5cbiAgLyoqXG4gICAqIFNldHMgYW4gaXRlbSBpbiBsb2NhbCBzdG9yYWdlXG4gICAqIEBwYXJhbSBrZXkgVGhlIGl0ZW0ncyBrZXlcbiAgICogQHBhcmFtIGRhdGEgVGhlIGl0ZW0ncyB2YWx1ZSwgbXVzdCBOT1QgYmUgbnVsbCBvciB1bmRlZmluZWRcbiAgICogQHJldHVybnMgQW4gUnhKUyBPYnNlcnZhYmxlIHRvIHdhaXQgdGhlIGVuZCBvZiB0aGUgb3BlcmF0aW9uXG4gICAqL1xuICBzZXRJdGVtKGtleTogc3RyaW5nLCBkYXRhOiBhbnkpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcblxuICAgIC8qIEZhbGxiYWNrIHN0b3JhZ2UgaWYgc2V0ICovXG4gICAgaWYgKHRoaXMuZmFsbGJhY2spIHtcbiAgICAgIHJldHVybiB0aGlzLmZhbGxiYWNrLnNldEl0ZW0oa2V5LCBkYXRhKTtcbiAgICB9XG5cbiAgICAvKiBTdG9yaW5nIG51bGwgaXMgbm90IGNvcnJlY3RseSBzdXBwb3J0ZWQgYnkgSW5kZXhlZERCIGFuZCB1bm5lY2Vzc2FyeSBoZXJlICovXG4gICAgaWYgKGRhdGEgPT0gbnVsbCkge1xuXG4gICAgICByZXR1cm4gb2YodHJ1ZSk7XG5cbiAgICB9XG5cbiAgICAvKiBUcmFuc2FjdGlvbiBtdXN0IGJlIHRoZSBzYW1lIGZvciByZWFkIGFuZCB3cml0ZSwgdG8gYXZvaWQgY29uY3VycmVuY3kgaXNzdWVzICovXG4gICAgY29uc3QgdHJhbnNhY3Rpb24kID0gdGhpcy50cmFuc2FjdGlvbigncmVhZHdyaXRlJyk7XG4gICAgbGV0IHRyYW5zYWN0aW9uOiBJREJPYmplY3RTdG9yZTtcblxuICAgICAgICAvKiBPcGVuaW5nIGEgdHJhbnNhY3Rpb24gKi9cbiAgICAgICAgcmV0dXJuIHRyYW5zYWN0aW9uJC5waXBlKFxuICAgICAgICAgIHRhcCgodmFsdWUpID0+IHtcbiAgICAgICAgICAgIHRyYW5zYWN0aW9uID0gdmFsdWU7XG4gICAgICAgICAgfSksXG4gICAgICAgICAgLyogQ2hlY2sgaWYgdGhlIGtleSBhbHJlYWR5IGV4aXN0cyBvciBub3RcbiAgICAgICAgICAgKiBgZ2V0S2V5KClgIGlzIG9ubHkgYXZhaWxhYmxlIGluIGluZGV4ZWREYiB2MiAoQ2hyb21lID49IDU4KVxuICAgICAgICAgICAqIEluIG9sZGVyIGJyb3dzZXJzLCB0aGUgdmFsdWUgaXMgY2hlY2tlZCBpbnN0ZWFkLCBidXQgaXQgY291bGQgbGVhZCB0byBhbiBleGNlcHRpb25cbiAgICAgICAgICAgKiBpZiBgdW5kZWZpbmVkYCB3YXMgc3RvcmVkIG91dHNpZGUgb2YgdGhpcyBsaWIgKGUuZy4gZGlyZWN0bHkgd2l0aCB0aGUgbmF0aXZlIGBpbmRleGVkRGJgIEFQSSlcbiAgICAgICAgICAgKi9cbiAgICAgICAgICBtYXAoKCkgPT4gKCdnZXRLZXknIGluIHRyYW5zYWN0aW9uKSA/IHRyYW5zYWN0aW9uLmdldEtleShrZXkpIDogKHRyYW5zYWN0aW9uIGFzIElEQk9iamVjdFN0b3JlKS5nZXQoa2V5KSksXG4gICAgICAgICAgbWVyZ2VNYXAoKHJlcXVlc3QpID0+IHtcblxuICAgICAgICAgICAgLyogTGlzdGVuaW5nIHRvIHRoZSBzdWNjZXNzIGV2ZW50LCBhbmQgcGFzc2luZyB0aGUgaXRlbSB2YWx1ZSBpZiBmb3VuZCwgbnVsbCBvdGhlcndpc2UgKi9cbiAgICAgICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSAoZnJvbUV2ZW50KHJlcXVlc3QsICdzdWNjZXNzJykgYXMgT2JzZXJ2YWJsZTxFdmVudD4pLnBpcGUoXG4gICAgICAgICAgICAgIG1hcCgoZXZlbnQpID0+IChldmVudC50YXJnZXQgYXMgSURCUmVxdWVzdCkucmVzdWx0IGFzIHN0cmluZyB8IHVuZGVmaW5lZCksXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAvKiBNZXJnaW5nIHN1Y2Nlc3MgYW5kIGVycm9ycyBldmVudHMgYW5kIGF1dG9jbG9zaW5nIHRoZSBvYnNlcnZhYmxlICovXG4gICAgICAgICAgICByZXR1cm4gKHJhY2Uoc3VjY2VzcywgdGhpcy50b0Vycm9yT2JzZXJ2YWJsZShyZXF1ZXN0LCBgc2V0dGVyYCkpKTtcblxuICAgICAgICAgIH0pLFxuICAgICAgICAgIG1lcmdlTWFwKChleGlzdGluZ0VudHJ5KSA9PiB7XG5cbiAgICAgICAgICAgIC8qIEFkZGluZyBvciB1cGRhdGluZyBsb2NhbCBzdG9yYWdlLCBiYXNlZCBvbiBwcmV2aW91cyBjaGVja2luZyAqL1xuICAgICAgICAgICAgY29uc3QgcmVxdWVzdDogSURCUmVxdWVzdCA9IChleGlzdGluZ0VudHJ5ID09PSB1bmRlZmluZWQpID9cbiAgICAgICAgICAgICAgdHJhbnNhY3Rpb24uYWRkKHsgW3RoaXMuZGF0YVBhdGhdOiBkYXRhIH0sIGtleSkgOlxuICAgICAgICAgICAgICB0cmFuc2FjdGlvbi5wdXQoeyBbdGhpcy5kYXRhUGF0aF06IGRhdGEgfSwga2V5KTtcblxuICAgICAgICAgICAgLyogTWVyZ2luZyBzdWNjZXNzIChwYXNzaW5nIHRydWUpIGFuZCBlcnJvciBldmVudHMgYW5kIGF1dG9jbG9zaW5nIHRoZSBvYnNlcnZhYmxlICovXG4gICAgICAgICAgICByZXR1cm4gKHJhY2UodGhpcy50b1N1Y2Nlc3NPYnNlcnZhYmxlKHJlcXVlc3QpLCB0aGlzLnRvRXJyb3JPYnNlcnZhYmxlKHJlcXVlc3QsIGBzZXR0ZXJgKSkpO1xuXG4gICAgICAgIH0pLFxuICAgICAgICBmaXJzdCgpXG4gICAgICApO1xuXG4gIH1cblxuICAvKipcbiAgICogRGVsZXRlcyBhbiBpdGVtIGluIGxvY2FsIHN0b3JhZ2VcbiAgICogQHBhcmFtIGtleSBUaGUgaXRlbSdzIGtleVxuICAgKiBAcmV0dXJucyBBbiBSeEpTIE9ic2VydmFibGUgdG8gd2FpdCB0aGUgZW5kIG9mIHRoZSBvcGVyYXRpb25cbiAgICovXG4gIHJlbW92ZUl0ZW0oa2V5OiBzdHJpbmcpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcblxuICAgIC8qIEZhbGxiYWNrIHN0b3JhZ2UgaWYgc2V0ICovXG4gICAgaWYgKHRoaXMuZmFsbGJhY2spIHtcbiAgICAgIHJldHVybiB0aGlzLmZhbGxiYWNrLnJlbW92ZUl0ZW0oa2V5KTtcbiAgICB9XG5cbiAgICAvKiBPcGVuaW5nIGEgdHJhbnNhY3Rpb24gYW5kIGNoZWNraW5nIGlmIHRoZSBpdGVtIGV4aXN0cyBpbiBsb2NhbCBzdG9yYWdlICovXG4gICAgcmV0dXJuIHRoaXMuZ2V0SXRlbShrZXkpLnBpcGUoXG4gICAgICBtZXJnZU1hcCgoZGF0YSkgPT4ge1xuXG4gICAgICAgIC8qIElmIHRoZSBpdGVtIGV4aXN0cyBpbiBsb2NhbCBzdG9yYWdlICovXG4gICAgICAgIGlmIChkYXRhICE9IG51bGwpIHtcblxuICAgICAgICAgIC8qIE9wZW5pbmcgYSB0cmFuc2FjdGlvbiAqL1xuICAgICAgICAgIHJldHVybiB0aGlzLnRyYW5zYWN0aW9uKCdyZWFkd3JpdGUnKS5waXBlKG1lcmdlTWFwKCh0cmFuc2FjdGlvbikgPT4ge1xuXG4gICAgICAgICAgICAvKiBEZWxldGluZyB0aGUgaXRlbSBpbiBsb2NhbCBzdG9yYWdlICovXG4gICAgICAgICAgICBjb25zdCByZXF1ZXN0ID0gdHJhbnNhY3Rpb24uZGVsZXRlKGtleSk7XG5cbiAgICAgICAgICAgIC8qIE1lcmdpbmcgc3VjY2VzcyAocGFzc2luZyB0cnVlKSBhbmQgZXJyb3IgZXZlbnRzIGFuZCBhdXRvY2xvc2luZyB0aGUgb2JzZXJ2YWJsZSAqL1xuICAgICAgICAgICAgcmV0dXJuIChyYWNlKHRoaXMudG9TdWNjZXNzT2JzZXJ2YWJsZShyZXF1ZXN0KSwgdGhpcy50b0Vycm9yT2JzZXJ2YWJsZShyZXF1ZXN0LCBgcmVtb3ZlcmApKSk7XG5cbiAgICAgICAgICB9KSk7XG5cbiAgICAgICAgfVxuXG4gICAgICAgIC8qIFBhc3NpbmcgdHJ1ZSBpZiB0aGUgaXRlbSBkb2VzIG5vdCBleGlzdCBpbiBsb2NhbCBzdG9yYWdlICovXG4gICAgICAgIHJldHVybiBvZih0cnVlKTtcblxuICAgICAgfSksXG4gICAgICBmaXJzdCgpXG4gICAgKTtcblxuICB9XG5cbiAgLyoqXG4gICAqIERlbGV0ZXMgYWxsIGl0ZW1zIGZyb20gbG9jYWwgc3RvcmFnZVxuICAgKiBAcmV0dXJucyBBbiBSeEpTIE9ic2VydmFibGUgdG8gd2FpdCB0aGUgZW5kIG9mIHRoZSBvcGVyYXRpb25cbiAgICovXG4gIGNsZWFyKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuXG4gICAgLyogRmFsbGJhY2sgc3RvcmFnZSBpZiBzZXQgKi9cbiAgICBpZiAodGhpcy5mYWxsYmFjaykge1xuICAgICAgcmV0dXJuIHRoaXMuZmFsbGJhY2suY2xlYXIoKTtcbiAgICB9XG5cbiAgICAvKiBPcGVuaW5nIGEgdHJhbnNhY3Rpb24gKi9cbiAgICByZXR1cm4gdGhpcy50cmFuc2FjdGlvbigncmVhZHdyaXRlJykucGlwZShcbiAgICAgIG1lcmdlTWFwKCh0cmFuc2FjdGlvbikgPT4ge1xuXG4gICAgICAgIC8qIERlbGV0aW5nIGFsbCBpdGVtcyBmcm9tIGxvY2FsIHN0b3JhZ2UgKi9cbiAgICAgICAgY29uc3QgcmVxdWVzdCA9IHRyYW5zYWN0aW9uLmNsZWFyKCk7XG5cbiAgICAgICAgLyogTWVyZ2luZyBzdWNjZXNzIChwYXNzaW5nIHRydWUpIGFuZCBlcnJvciBldmVudHMgYW5kIGF1dG9jbG9zaW5nIHRoZSBvYnNlcnZhYmxlICovXG4gICAgICAgIHJldHVybiAocmFjZSh0aGlzLnRvU3VjY2Vzc09ic2VydmFibGUocmVxdWVzdCksIHRoaXMudG9FcnJvck9ic2VydmFibGUocmVxdWVzdCwgYGNsZWFyZXJgKSkpO1xuXG4gICAgICB9KSxcbiAgICAgIGZpcnN0KClcbiAgICApO1xuXG4gIH1cblxuICBrZXlzKCk6IE9ic2VydmFibGU8c3RyaW5nW10+IHtcblxuICAgIC8qIEZhbGxiYWNrIHN0b3JhZ2UgaWYgc2V0ICovXG4gICAgaWYgKHRoaXMuZmFsbGJhY2spIHtcbiAgICAgIHJldHVybiB0aGlzLmZhbGxiYWNrLmtleXMoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy50cmFuc2FjdGlvbigncmVhZG9ubHknKS5waXBlKFxuICAgICAgbWVyZ2VNYXAoKHRyYW5zYWN0aW9uKSA9PiB7XG5cbiAgICAgICAgaWYgKCdnZXRBbGxLZXlzJyBpbiB0cmFuc2FjdGlvbikge1xuXG4gICAgICAgICAgLyogRGVsZXRpbmcgdGhlIGl0ZW0gaW4gbG9jYWwgc3RvcmFnZSAqL1xuICAgICAgICAgIGNvbnN0IHJlcXVlc3QgPSB0cmFuc2FjdGlvbi5nZXRBbGxLZXlzKCk7XG5cbiAgICAgICAgICBjb25zdCBzdWNjZXNzID0gKGZyb21FdmVudChyZXF1ZXN0LCAnc3VjY2VzcycpIGFzIE9ic2VydmFibGU8RXZlbnQ+KS5waXBlKFxuICAgICAgICAgICAgbWFwKChldmVudCkgPT4gKGV2ZW50LnRhcmdldCBhcyBJREJSZXF1ZXN0KS5yZXN1bHQgYXMgc3RyaW5nW10pXG4gICAgICAgICAgKTtcblxuICAgICAgICAgIC8qIE1lcmdpbmcgc3VjY2VzcyBhbmQgZXJyb3JzIGV2ZW50cyBhbmQgYXV0b2Nsb3NpbmcgdGhlIG9ic2VydmFibGUgKi9cbiAgICAgICAgICByZXR1cm4gKHJhY2Uoc3VjY2VzcywgdGhpcy50b0Vycm9yT2JzZXJ2YWJsZShyZXF1ZXN0LCBga2V5c2ApKSk7XG5cbiAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgIC8qIGBnZXRBbGxLZXlzKClgIGlzIGZyb20gSW5kZXhlZERCIHYyLjAgc3RhbmRhcmQsIHdoaWNoIGlzIG5vdCBzdXBwb3J0ZWQgaW4gSUUvRWRnZSAqL1xuXG4gICAgICAgICAgY29uc3QgcmVxdWVzdCA9ICh0cmFuc2FjdGlvbiBhcyBJREJPYmplY3RTdG9yZSkub3BlbkN1cnNvcigpO1xuXG4gICAgICAgICAgY29uc3Qga2V5czogc3RyaW5nW10gPSBbXTtcblxuICAgICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBmcm9tRXZlbnQocmVxdWVzdCwgJ3N1Y2Nlc3MnKS5waXBlKFxuICAgICAgICAgICAgbWFwKChldmVudCkgPT4gKGV2ZW50LnRhcmdldCBhcyBJREJSZXF1ZXN0KS5yZXN1bHQgYXMgSURCQ3Vyc29yV2l0aFZhbHVlKSxcbiAgICAgICAgICAgIHRhcCgoY3Vyc29yKSA9PiAge1xuICAgICAgICAgICAgICBpZiAoY3Vyc29yKSB7XG4gICAgICAgICAgICAgICAga2V5cy5wdXNoKGN1cnNvci5rZXkgYXMgc3RyaW5nKTtcbiAgICAgICAgICAgICAgICBjdXJzb3IuY29udGludWUoKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBmaWx0ZXIoKGN1cnNvcikgPT4gIWN1cnNvciksXG4gICAgICAgICAgICBtYXAoKCkgPT4ga2V5cylcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgLyogTWVyZ2luZyBzdWNjZXNzIGFuZCBlcnJvcnMgZXZlbnRzIGFuZCBhdXRvY2xvc2luZyB0aGUgb2JzZXJ2YWJsZSAqL1xuICAgICAgICAgIHJldHVybiAocmFjZShzdWNjZXNzLCB0aGlzLnRvRXJyb3JPYnNlcnZhYmxlKHJlcXVlc3QsIGBrZXlzYCkpKTtcblxuICAgICAgICB9XG5cbiAgICAgIH0pLFxuICAgICAgZmlyc3QoKVxuICAgICk7XG5cbiAgfVxuXG4gIGhhcyhrZXk6IHN0cmluZyk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuXG4gICAgLyogRmFsbGJhY2sgc3RvcmFnZSBpZiBzZXQgKi9cbiAgICBpZiAodGhpcy5mYWxsYmFjaykge1xuICAgICAgcmV0dXJuIHRoaXMuZmFsbGJhY2suaGFzKGtleSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMudHJhbnNhY3Rpb24oJ3JlYWRvbmx5JykucGlwZShcbiAgICAgIC8qIGBnZXRLZXkoKWAgaXMgZnJvbSBJbmRleGVkREIgdjIuMCBzdGFuZGFyZCwgd2hpY2ggaXMgbm90IHN1cHBvcnRlZCBpbiBJRS9FZGdlICovXG4gICAgICBtYXAoKHRyYW5zYWN0aW9uKSA9PiAoJ2dldEtleScgaW4gdHJhbnNhY3Rpb24pID8gdHJhbnNhY3Rpb24uZ2V0S2V5KGtleSkgOiAodHJhbnNhY3Rpb24gYXMgSURCT2JqZWN0U3RvcmUpLmdldChrZXkpKSxcbiAgICAgIG1lcmdlTWFwKChyZXF1ZXN0KSA9PiB7XG5cbiAgICAgICAgLyogTGlzdGVuaW5nIHRvIHRoZSBzdWNjZXNzIGV2ZW50LCBhbmQgcGFzc2luZyB0aGUgaXRlbSB2YWx1ZSBpZiBmb3VuZCwgbnVsbCBvdGhlcndpc2UgKi9cbiAgICAgICAgY29uc3Qgc3VjY2VzcyA9IChmcm9tRXZlbnQocmVxdWVzdCwgJ3N1Y2Nlc3MnKSBhcyBPYnNlcnZhYmxlPEV2ZW50PikucGlwZShcbiAgICAgICAgICBtYXAoKGV2ZW50KSA9PiAoZXZlbnQudGFyZ2V0IGFzIElEQlJlcXVlc3QpLnJlc3VsdCksXG4gICAgICAgICAgbWFwKChyZXN1bHQpID0+IChyZXN1bHQgIT09IHVuZGVmaW5lZCkgPyB0cnVlIDogZmFsc2UpXG4gICAgICAgICk7XG5cbiAgICAgICAgLyogTWVyZ2luZyBzdWNjZXNzIGFuZCBlcnJvcnMgZXZlbnRzIGFuZCBhdXRvY2xvc2luZyB0aGUgb2JzZXJ2YWJsZSAqL1xuICAgICAgICByZXR1cm4gKHJhY2Uoc3VjY2VzcywgdGhpcy50b0Vycm9yT2JzZXJ2YWJsZShyZXF1ZXN0LCBgaGFzYCkpKTtcbiAgICAgIH0pLFxuICAgICAgZmlyc3QoKVxuICAgICk7XG5cbiAgfVxuXG4gIC8qKlxuICAgKiBDb25uZWN0cyB0byBJbmRleGVkREIgYW5kIGNyZWF0ZXMgdGhlIG9iamVjdCBzdG9yZSBvbiBmaXJzdCB0aW1lXG4gICAqL1xuICBwcm90ZWN0ZWQgY29ubmVjdChwcmVmaXg6IHN0cmluZyB8IG51bGwgPSBudWxsKTogdm9pZCB7XG5cbiAgICBsZXQgcmVxdWVzdDogSURCT3BlbkRCUmVxdWVzdDtcblxuICAgIC8qIENvbm5lY3RpbmcgdG8gSW5kZXhlZERCICovXG4gICAgdHJ5IHtcblxuICAgICAgcmVxdWVzdCA9IGluZGV4ZWREQi5vcGVuKHRoaXMuZGJOYW1lKTtcblxuICAgIH3CoGNhdGNoIChlcnJvcikge1xuXG4gICAgICAvKiBGYWxsYmFjayBzdG9yYWdlIGlmIEluZGV4ZWREYiBjb25uZWN0aW9uIGlzIGZhaWxpbmcgKi9cbiAgICAgIHRoaXMuc2V0RmFsbGJhY2socHJlZml4KTtcblxuICAgICAgcmV0dXJuO1xuXG4gICAgfVxuXG4gICAgLyogTGlzdGVuaW5nIHRoZSBldmVudCBmaXJlZCBvbiBmaXJzdCBjb25uZWN0aW9uLCBjcmVhdGluZyB0aGUgb2JqZWN0IHN0b3JlIGZvciBsb2NhbCBzdG9yYWdlICovXG4gICAgKGZyb21FdmVudChyZXF1ZXN0LCAndXBncmFkZW5lZWRlZCcpIGFzIE9ic2VydmFibGU8RXZlbnQ+KVxuICAgICAgLnBpcGUoZmlyc3QoKSlcbiAgICAgIC5zdWJzY3JpYmUoKGV2ZW50KSA9PiB7XG5cbiAgICAgICAgLyogR2V0dGluZyB0aGUgZGF0YWJhc2UgY29ubmVjdGlvbiAqL1xuICAgICAgICBjb25zdCBkYXRhYmFzZSA9IChldmVudC50YXJnZXQgYXMgSURCUmVxdWVzdCkucmVzdWx0IGFzIElEQkRhdGFiYXNlO1xuXG4gICAgICAgIC8qIENoZWNraW5nIGlmIHRoZSBvYmplY3Qgc3RvcmUgYWxyZWFkeSBleGlzdHMsIHRvIGF2b2lkIGVycm9yICovXG4gICAgICAgIGlmICghZGF0YWJhc2Uub2JqZWN0U3RvcmVOYW1lcy5jb250YWlucyh0aGlzLm9iamVjdFN0b3JlTmFtZSkpIHtcblxuICAgICAgICAgIC8qIENyZWF0aW5nIHRoZSBvYmplY3Qgc3RvcmUgZm9yIGxvY2FsIHN0b3JhZ2UgKi9cbiAgICAgICAgICBkYXRhYmFzZS5jcmVhdGVPYmplY3RTdG9yZSh0aGlzLm9iamVjdFN0b3JlTmFtZSk7XG5cbiAgICAgICAgfVxuXG4gICAgICB9KTtcblxuICAgIC8qIExpc3RlbmluZyB0aGUgc3VjY2VzcyBldmVudCBhbmQgY29udmVydGluZyB0byBhbiBSeEpTIE9ic2VydmFibGUgKi9cbiAgICBjb25zdCBzdWNjZXNzID0gZnJvbUV2ZW50KHJlcXVlc3QsICdzdWNjZXNzJykgYXMgT2JzZXJ2YWJsZTxFdmVudD47XG5cbiAgICAvKiBNZXJnaW5nIHN1Y2Nlc3MgYW5kIGVycm9ycyBldmVudHMgKi9cbiAgICAocmFjZShzdWNjZXNzLCB0aGlzLnRvRXJyb3JPYnNlcnZhYmxlKHJlcXVlc3QsIGBjb25uZWN0aW9uYCkpIGFzIE9ic2VydmFibGU8RXZlbnQ+KVxuICAgICAgLnBpcGUoZmlyc3QoKSlcbiAgICAgIC5zdWJzY3JpYmUoKGV2ZW50KSA9PiB7XG5cbiAgICAgICAgLyogU3RvcmluZyB0aGUgZGF0YWJhc2UgY29ubmVjdGlvbiBmb3IgZnVydGhlciBhY2Nlc3MgKi9cbiAgICAgICAgdGhpcy5kYXRhYmFzZS5uZXh0KChldmVudC50YXJnZXQgYXMgSURCUmVxdWVzdCkucmVzdWx0IGFzIElEQkRhdGFiYXNlKTtcblxuICAgICAgfSwgKCkgPT4ge1xuXG4gICAgICAgIC8qIEZhbGxiYWNrIHN0b3JhZ2UgaWYgSW5kZXhlZERiIGNvbm5lY3Rpb24gaXMgZmFpbGluZyAqL1xuICAgICAgICB0aGlzLnNldEZhbGxiYWNrKHByZWZpeCk7XG5cbiAgICAgIH0pO1xuXG4gIH1cblxuICAvKipcbiAgICogT3BlbnMgYW4gSW5kZXhlZERCIHRyYW5zYWN0aW9uIGFuZCBnZXRzIHRoZSBsb2NhbCBzdG9yYWdlIG9iamVjdCBzdG9yZVxuICAgKiBAcGFyYW0gbW9kZSBEZWZhdWx0IHRvICdyZWFkb25seScgZm9yIHJlYWQgb3BlcmF0aW9ucywgb3IgJ3JlYWR3cml0ZScgZm9yIHdyaXRlIG9wZXJhdGlvbnNcbiAgICogQHJldHVybnMgQW4gSW5kZXhlZERCIHRyYW5zYWN0aW9uIG9iamVjdCBzdG9yZSwgd3JhcHBlZCBpbiBhbiBSeEpTIE9ic2VydmFibGVcbiAgICovXG4gIHByb3RlY3RlZCB0cmFuc2FjdGlvbihtb2RlOiAncmVhZG9ubHknIHwgJ3JlYWR3cml0ZScgPSAncmVhZG9ubHknKTogT2JzZXJ2YWJsZTxJREJPYmplY3RTdG9yZT4ge1xuXG4gICAgLyogRnJvbSB0aGUgSW5kZXhlZERCIGNvbm5lY3Rpb24sIG9wZW5pbmcgYSB0cmFuc2FjdGlvbiBhbmQgZ2V0dGluZyB0aGUgbG9jYWwgc3RvcmFnZSBvYmpldCBzdG9yZSAqL1xuICAgIHJldHVybiB0aGlzLmRhdGFiYXNlXG4gICAgICAucGlwZShtYXAoKGRhdGFiYXNlKSA9PiBkYXRhYmFzZS50cmFuc2FjdGlvbihbdGhpcy5vYmplY3RTdG9yZU5hbWVdLCBtb2RlKS5vYmplY3RTdG9yZSh0aGlzLm9iamVjdFN0b3JlTmFtZSkpKTtcblxuICB9XG5cbiAgLyoqXG4gICAqIFRyYW5zZm9ybXMgYSBJbmRleGVkREIgc3VjY2VzcyBldmVudCBpbiBhbiBSeEpTIE9ic2VydmFibGVcbiAgICogQHBhcmFtIHJlcXVlc3QgVGhlIHJlcXVlc3QgdG8gbGlzdGVuXG4gICAqIEByZXR1cm5zIEEgUnhKUyBPYnNlcnZhYmxlIHdpdGggdHJ1ZSB2YWx1ZVxuICAgKi9cbiAgcHJvdGVjdGVkIHRvU3VjY2Vzc09ic2VydmFibGUocmVxdWVzdDogSURCUmVxdWVzdCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuXG4gICAgLyogVHJhbnNmb3JtaW5nIGEgSW5kZXhlZERCIHN1Y2Nlc3MgZXZlbnQgaW4gYW4gUnhKUyBPYnNlcnZhYmxlIHdpdGggdHJ1ZSB2YWx1ZSAqL1xuICAgIHJldHVybiAoZnJvbUV2ZW50KHJlcXVlc3QsICdzdWNjZXNzJykgYXMgT2JzZXJ2YWJsZTxFdmVudD4pXG4gICAgICAucGlwZShtYXAoKCkgPT4gdHJ1ZSkpO1xuXG4gIH1cblxuICAvKipcbiAgICogVHJhbnNmb3JtcyBhIEluZGV4ZWREQiBlcnJvciBldmVudCBpbiBhbiBSeEpTIEVycm9yT2JzZXJ2YWJsZVxuICAgKiBAcGFyYW0gcmVxdWVzdCBUaGUgcmVxdWVzdCB0byBsaXN0ZW5cbiAgICogQHBhcmFtIGVycm9yIE9wdGlvbm5hbCBkZXRhaWxzIGFib3V0IHRoZSBlcnJvcidzIG9yaWdpblxuICAgKiBAcmV0dXJucyBBIFJ4SlMgRXJyb3JPYnNlcnZhYmxlXG4gICAqL1xuICBwcm90ZWN0ZWQgdG9FcnJvck9ic2VydmFibGUocmVxdWVzdDogSURCUmVxdWVzdCwgZXJyb3IgPSBgYCk6IE9ic2VydmFibGU8bmV2ZXI+IHtcblxuICAgIC8qIFRyYW5zZm9ybWluZyBhIEluZGV4ZWREQiBlcnJvciBldmVudCBpbiBhbiBSeEpTIEVycm9yT2JzZXJ2YWJsZSAqL1xuICAgIHJldHVybiAoZnJvbUV2ZW50KHJlcXVlc3QsICdlcnJvcicpIGFzIE9ic2VydmFibGU8RXZlbnQ+KVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1lcmdlTWFwKCgpID0+IHRocm93RXJyb3IobmV3IEVycm9yKGBJbmRleGVkREIgJHtlcnJvcn0gaXNzdWUgOiAkeyhyZXF1ZXN0LmVycm9yIGFzIERPTUV4Y2VwdGlvbikubWVzc2FnZX0uYCkpKVxuICAgICAgKTtcblxuICB9XG5cbiAgcHJvdGVjdGVkIHNldEZhbGxiYWNrKHByZWZpeDogc3RyaW5nIHwgbnVsbCk6IHZvaWQge1xuICAgIHRoaXMuZmFsbGJhY2sgPSBuZXcgTG9jYWxTdG9yYWdlRGF0YWJhc2UocHJlZml4KTtcbiAgfVxuXG59XG4iXX0=